<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategic GTM Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState } = React;

        // Inline SVG Icons
        const BarChart3 = (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><rect width="4" height="7" x="7" y="10" rx="1"/><rect width="4" height="12" x="15" y="5" rx="1"/></svg>;
        const Target = (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>;
        const Activity = (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>;
        const CheckCircle = (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>;
        const AlertTriangle = (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>;
        const AlertCircle = (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>;
        const Globe = (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>;
        const MapPin = (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0 Z"/><circle cx="12" cy="10" r="3"/></svg>;
        const Users = (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
        const ArrowRight = (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" x2="19" y1="12" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>;
        const ArrowLeft = (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="19" x2="5" y1="12" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>;
        const Zap = (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>;
        const Layout = (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="9" x2="9" y1="21" y2="9"/></svg>;
        const Upload = (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>;
        const Download = (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>;
        const FileText = (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>;
        const DollarSign = (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>;
        const Package = (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>;
        const TrendingUp = (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>;
        const Briefcase = (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>;
        const Award = (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/></svg>;
        const Building2 = (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></svg>;
        const Eye = (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>;
        const Lightbulb = (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>;

        // Parse analysis text into sections
        const parseAnalysis = (text) => {
            const sections = {};
            const lines = text.split('\n');
            let currentSection = '';
            let currentContent = [];

            lines.forEach(line => {
                if (line.match(/^##\s+/)) {
                    if (currentSection) {
                        sections[currentSection] = currentContent.join('\n').trim();
                    }
                    currentSection = line.replace(/^##\s+/, '').replace(/\*\*/g, '').trim();
                    currentContent = [];
                } else if (currentSection) {
                    currentContent.push(line);
                }
            });

            if (currentSection) {
                sections[currentSection] = currentContent.join('\n').trim();
            }

            return sections;
        };

        // Enhanced Content Renderer with Beautiful Formatting
        const ContentRenderer = ({ content, sectionName }) => {
            if (!content) return null;

            // Parse content into structured elements
            const parseContent = (text) => {
                const lines = text.split('\n');
                const elements = [];
                let currentList = null;
                let currentParagraph = '';

                lines.forEach((line, idx) => {
                    // Headers
                    if (line.match(/^\*?\*?([A-Z][^:]+):\*?\*?$/)) {
                        if (currentParagraph) {
                            elements.push({ type: 'paragraph', content: currentParagraph });
                            currentParagraph = '';
                        }
                        if (currentList) {
                            elements.push(currentList);
                            currentList = null;
                        }
                        elements.push({ type: 'header', content: line.replace(/\*\*/g, '').replace(':', '') });
                    }
                    // Subheaders (###)
                    else if (line.match(/^###\s+(.+)/)) {
                        if (currentParagraph) {
                            elements.push({ type: 'paragraph', content: currentParagraph });
                            currentParagraph = '';
                        }
                        if (currentList) {
                            elements.push(currentList);
                            currentList = null;
                        }
                        elements.push({ type: 'subheader', content: line.replace(/^###\s+/, '') });
                    }
                    // Bullet points
                    else if (line.match(/^[-•]\s+(.+)/)) {
                        if (currentParagraph) {
                            elements.push({ type: 'paragraph', content: currentParagraph });
                            currentParagraph = '';
                        }
                        if (!currentList) {
                            currentList = { type: 'list', items: [] };
                        }
                        currentList.items.push(line.replace(/^[-•]\s+/, ''));
                    }
                    // Numbered lists
                    else if (line.match(/^\d+\.\s+(.+)/)) {
                        if (currentParagraph) {
                            elements.push({ type: 'paragraph', content: currentParagraph });
                            currentParagraph = '';
                        }
                        if (!currentList) {
                            currentList = { type: 'numbered', items: [] };
                        }
                        currentList.items.push(line.replace(/^\d+\.\s+/, ''));
                    }
                    // Empty line
                    else if (line.trim() === '') {
                        if (currentParagraph) {
                            elements.push({ type: 'paragraph', content: currentParagraph });
                            currentParagraph = '';
                        }
                        if (currentList) {
                            elements.push(currentList);
                            currentList = null;
                        }
                    }
                    // Regular text
                    else if (line.trim()) {
                        if (currentList) {
                            elements.push(currentList);
                            currentList = null;
                        }
                        currentParagraph += (currentParagraph ? ' ' : '') + line.trim();
                    }
                });

                if (currentParagraph) {
                    elements.push({ type: 'paragraph', content: currentParagraph });
                }
                if (currentList) {
                    elements.push(currentList);
                }

                return elements;
            };

            const elements = parseContent(content);

            return (
                <div className="bg-white rounded-xl p-6 border-2 border-gray-200">
                    <div className="space-y-6" style={{ maxHeight: '600px', overflowY: 'auto', paddingRight: '10px' }}>
                        {elements.map((element, idx) => {
                        if (element.type === 'header') {
                            return (
                                <div key={idx} className="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl p-6 text-white shadow-lg">
                                    <h3 className="text-xl font-bold">{element.content}</h3>
                                </div>
                            );
                        }
                        
                        if (element.type === 'subheader') {
                            return (
                                <h4 key={idx} className="text-lg font-bold text-gray-900 mt-6 mb-3 flex items-center">
                                    <Zap className="w-5 h-5 mr-2 text-blue-600" />
                                    {element.content}
                                </h4>
                            );
                        }
                        
                        if (element.type === 'paragraph') {
                            const text = element.content
                                .replace(/\*\*([^*]+)\*\*/g, '<strong class="font-semibold text-gray-900">$1</strong>');
                            return (
                                <p key={idx} className="text-gray-700 leading-relaxed" dangerouslySetInnerHTML={{ __html: text }} />
                            );
                        }
                        
                        if (element.type === 'list') {
                            return (
                                <div key={idx} className="bg-blue-50 rounded-xl p-6 border border-blue-200">
                                    <div className="space-y-3">
                                        {element.items.map((item, itemIdx) => {
                                            const text = item.replace(/\*\*([^*]+)\*\*/g, '<strong class="font-semibold text-blue-900">$1</strong>');
                                            return (
                                                <div key={itemIdx} className="flex items-start">
                                                    <div className="w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0 mr-3 mt-0.5">
                                                        <CheckCircle className="w-4 h-4 text-white" />
                                                    </div>
                                                    <span className="text-gray-700 flex-1" dangerouslySetInnerHTML={{ __html: text }} />
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            );
                        }
                        
                        if (element.type === 'numbered') {
                            return (
                                <div key={idx} className="bg-white rounded-xl p-6 border-2 border-gray-200">
                                    <div className="space-y-4">
                                        {element.items.map((item, itemIdx) => {
                                            const text = item.replace(/\*\*([^*]+)\*\*/g, '<strong class="font-semibold text-gray-900">$1</strong>');
                                            return (
                                                <div key={itemIdx} className="flex items-start">
                                                    <div className="w-8 h-8 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center flex-shrink-0 mr-3 text-white font-bold">
                                                        {itemIdx + 1}
                                                    </div>
                                                    <span className="text-gray-700 flex-1 pt-1" dangerouslySetInnerHTML={{ __html: text }} />
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            );
                        }
                        
                        return null;
                    })}
                    </div>
                </div>
            );
        };

        // Icon mapping for sections
        const getSectionIcon = (sectionName) => {
            const name = sectionName.toLowerCase();
            if (name.includes('overview')) return Building2;
            if (name.includes('financial')) return DollarSign;
            if (name.includes('prospect')) return Target;
            if (name.includes('win theme')) return Award;
            if (name.includes('solution')) return Package;
            if (name.includes('personnel') || name.includes('key')) return Users;
            if (name.includes('engagement')) return Briefcase;
            if (name.includes('action plan') || name.includes('go-to-market') || name.includes('gtm')) return Zap;
            if (name.includes('marketing')) return TrendingUp;
            if (name.includes('team')) return Users;
            if (name.includes('metric')) return Activity;
            if (name.includes('ownership') || name.includes('auditor')) return Award;
            return Layout;
        };

        function BiAnalystAgent() {
          const [activeMode, setActiveMode] = useState('individual');
          const [companyInput, setCompanyInput] = useState('');
          const [directive, setDirective] = useState('');
          const [loading, setLoading] = useState(false);
          const [analysis, setAnalysis] = useState(null);
          const [error, setError] = useState('');
          const [activeTab, setActiveTab] = useState(null);
          
          const [batchResults, setBatchResults] = useState([]);
          const [batchLoading, setBatchLoading] = useState(false);
          const [batchProgress, setBatchProgress] = useState(0);
          const [batchJobId, setBatchJobId] = useState(null);
          const [selectedFile, setSelectedFile] = useState(null);
          const [selectedBatchCompany, setSelectedBatchCompany] = useState(null);

          const sampleDirectives = [
            "Evaluate as potential customer for enterprise cloud services",
            "Assess for strategic partnership in AI/ML solutions",
            "Investment analysis for acquisition opportunity",
            "Competitive analysis for market positioning"
          ];

          const getProspectColor = (level) => {
            const colors = { 
              'High': 'from-green-500 to-emerald-600', 
              'Medium': 'from-yellow-500 to-orange-500', 
              'Low': 'from-red-500 to-rose-600' 
            };
            return colors[level] || 'from-gray-500 to-gray-600';
          };

          const getScoreColor = (score) => {
            if (score === 'Unknown' || !score || score === 'N/A') return 'text-gray-600 bg-gray-50 border-gray-200';
            const numScore = typeof score === 'string' ? parseInt(score) : score;
            if (numScore >= 85) return 'text-green-600 bg-green-50 border-green-200';
            if (numScore >= 70) return 'text-blue-600 bg-blue-50 border-blue-200';
            if (numScore >= 50) return 'text-yellow-600 bg-yellow-50 border-yellow-200';
            return 'text-red-600 bg-red-50 border-red-200';
          };

          const getAuditorColor = (status) => {
            if (!status) return 'text-gray-700 bg-gray-50 border-gray-300';
            return status.includes('CHECK') || status.includes('DESC') ? 'text-orange-700 bg-orange-50 border-orange-300' : 'text-green-700 bg-green-50 border-green-300';
          };

          const getBadgeColor = (level) => {
            if (level === 'High') return 'bg-green-100 text-green-700';
            if (level === 'Medium') return 'bg-yellow-100 text-yellow-700';
            if (level === 'Low') return 'bg-red-100 text-red-700';
            return 'bg-gray-100 text-gray-700';
          };

          const handleAnalyze = async () => {
            if (!companyInput.trim() || !directive.trim()) {
              setError('Please enter both company name and analysis directive');
              return;
            }

            setLoading(true);
            setError('');
            setAnalysis(null);

            try {
              const response = await fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ company: companyInput, directive: directive })
              });

              const data = await response.json();
              
              if (data.success) {
                const sections = parseAnalysis(data.analysis);
                const sectionKeys = Object.keys(sections);
                
                setAnalysis({
                  companyName: data.company,
                  directive: data.directive,
                  prospectLevel: data.prospectLevel,
                  score: data.score,
                  auditorStatus: data.auditorStatus,
                  industry: data.industry,
                  location: data.location,
                  employees: data.employees,
                  sections: sections,
                  fullAnalysis: data.analysis
                });
                
                if (sectionKeys.length > 0) {
                  setActiveTab(sectionKeys[0]);
                }
              } else {
                setError('Analysis failed: ' + data.error);
              }
            } catch (err) {
              setError('Error: ' + err.message);
            } finally {
              setLoading(false);
            }
          };

          const handleReset = () => {
            setAnalysis(null);
            setCompanyInput('');
            setDirective('');
            setError('');
            setActiveTab(null);
          };

          const handleFileSelect = (e) => {
            const file = e.target.files[0];
            if (file) {
              setSelectedFile(file);
            }
          };

          const handleBatchAnalyze = async () => {
            if (!selectedFile) {
              setError('Please select a file');
              return;
            }

            setBatchLoading(true);
            setError('');
            setBatchResults([]);
            setBatchProgress(0);

            try {
              const formData = new FormData();
              formData.append('file', selectedFile);

              // Start batch job
              const response = await fetch('/api/batch-analyze', {
                method: 'POST',
                body: formData
              });

              const data = await response.json();
              
              if (data.success) {
                const jobId = data.job_id;
                setBatchJobId(jobId);
                
                // Poll for status
                const pollInterval = setInterval(async () => {
                  try {
                    const statusResponse = await fetch(`/api/batch-status/${jobId}`);
                    const statusData = await statusResponse.json();
                    
                    if (statusData.success) {
                      setBatchProgress(statusData.progress || 0);
                      
                      if (statusData.status === 'completed') {
                        clearInterval(pollInterval);
                        setBatchResults(statusData.results);
                        setBatchLoading(false);
                        setBatchJobId(null);
                      } else if (statusData.status === 'failed') {
                        clearInterval(pollInterval);
                        setError('Batch analysis failed: ' + statusData.error);
                        setBatchLoading(false);
                        setBatchJobId(null);
                      }
                    }
                  } catch (err) {
                    console.error('Polling error:', err);
                  }
                }, 3000); // Poll every 3 seconds
                
              } else {
                setError('Batch analysis failed: ' + data.error);
                setBatchLoading(false);
              }
            } catch (err) {
              setError('Error: ' + err.message);
              setBatchLoading(false);
            }
          };

          const handleExportExcel = async () => {
            try {
              const response = await fetch('/api/export-excel', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ results: batchResults })
              });

              const blob = await response.blob();
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = 'bi_analysis_' + new Date().toISOString().slice(0,10) + '.xlsx';
              a.click();
            } catch (err) {
              setError('Export failed: ' + err.message);
            }
          };

          const downloadTemplate = () => {
            const csv = 'company_name,directive\nTesla,Evaluate for ERP upgrade\nMicrosoft,Partnership opportunity\n';
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'batch_template.csv';
            a.click();
          };

          const viewBatchCompanyDetails = (result) => {
            const sections = parseAnalysis(result.analysis);
            const sectionKeys = Object.keys(sections);
            
            const detailedAnalysis = {
              companyName: result.company,
              directive: result.directive,
              prospectLevel: result.prospect_level,
              score: result.score,
              auditorStatus: result.structured_data?.auditor_status || 'Unknown - needs manual research',
              industry: result.structured_data?.industry || 'Unknown - needs manual research',
              location: result.structured_data?.location || 'Unknown - needs manual research',
              employees: result.structured_data?.employees || 'Unknown - needs manual research',
              sections: sections,
              fullAnalysis: result.analysis
            };
            
            setSelectedBatchCompany(detailedAnalysis);
            if (sectionKeys.length > 0) {
              setActiveTab(sectionKeys[0]);
            }
          };

          const closeBatchDetails = () => {
            setSelectedBatchCompany(null);
            setActiveTab(null);
          };

          const renderDashboardHeader = (analysisData) => {
            if (!analysisData) return null;
            
            // Convert score to number if it's a string
            let displayScore = analysisData.score;
            if (typeof displayScore === 'string' && displayScore !== 'Unknown') {
              displayScore = parseInt(displayScore, 10);
            }
            
            // Handle N/A cases
            if (!displayScore || displayScore === 'Unknown' || displayScore === 'N/A' || isNaN(displayScore)) {
              displayScore = 'N/A';
            }
            
            const displayScoreText = displayScore === 'N/A' ? displayScore : `${displayScore}/100`;
            
            return (
              <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div className={`bg-gradient-to-br ${getProspectColor(analysisData.prospectLevel)} rounded-xl p-6 text-white shadow-lg transform hover:scale-105 transition-transform`}>
                  <div className="flex items-center justify-between mb-2">
                    <div className="text-sm font-semibold uppercase tracking-wide opacity-90">Prospect Level</div>
                    <Target className="w-6 h-6" />
                  </div>
                  <div className="text-4xl font-bold mb-1">{analysisData.prospectLevel}</div>
                </div>
                
                <div className={`${getScoreColor(analysisData.score)} border-2 rounded-xl p-6 shadow-lg transform hover:scale-105 transition-transform`}>
                  <div className="flex items-center justify-between mb-2">
                    <div className="text-sm font-semibold uppercase tracking-wide">Analysis Score</div>
                    <Activity className="w-6 h-6" />
                  </div>
                  <div className="text-4xl font-bold mb-1">{displayScoreText}</div>
                  <div className="text-sm opacity-75">
                    {displayScore === 'N/A' ? 'Not Available' :
                     displayScore >= 85 ? 'Excellent Fit' : 
                     displayScore >= 70 ? 'Strong Fit' : 
                     displayScore >= 50 ? 'Moderate Fit' : 'Low Fit'}
                  </div>
                </div>
                
                <div className={`${getAuditorColor(analysisData.auditorStatus)} border-2 rounded-xl p-6 shadow-lg transform hover:scale-105 transition-transform`}>
                  <div className="flex items-center justify-between mb-2">
                    <div className="text-sm font-semibold uppercase tracking-wide">Auditor Status</div>
                    {analysisData.auditorStatus && (analysisData.auditorStatus.includes('CHECK') || analysisData.auditorStatus.includes('DESC')) ? 
                      <AlertTriangle className="w-6 h-6" /> : 
                      <CheckCircle className="w-6 h-6" />
                    }
                  </div>
                  <div className="text-lg font-bold mb-1">
                    {analysisData.auditorStatus && (analysisData.auditorStatus.includes('CHECK') || analysisData.auditorStatus.includes('DESC')) ? 'Review Required' : 
                     analysisData.auditorStatus && analysisData.auditorStatus.includes('Unknown') ? 'Unknown' : 'Clear'}
                  </div>
                  <div className="text-sm opacity-75">{analysisData.auditorStatus || 'Not Available'}</div>
                </div>
                
                <div className="bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl p-6 text-white shadow-lg">
                  <div className="text-sm font-semibold uppercase tracking-wide opacity-90 mb-2">Quick Info</div>
                  <div className="space-y-1 text-sm">
                    <div className="flex items-center"><Globe className="w-4 h-4 mr-2" /><span>{analysisData.industry || 'Unknown'}</span></div>
                    <div className="flex items-center"><MapPin className="w-4 h-4 mr-2" /><span>{analysisData.location || 'Unknown'}</span></div>
                    <div className="flex items-center"><Users className="w-4 h-4 mr-2" /><span>{analysisData.employees || 'Unknown'}</span></div>
                  </div>
                </div>
              </div>
            );
          };

          const renderDashboardTabs = (analysisData) => {
            if (!analysisData || !analysisData.sections) return null;
            
            const sectionKeys = Object.keys(analysisData.sections);
            if (sectionKeys.length === 0) return null;

            return (
              <div className="mb-6">
                <div className="bg-white rounded-xl shadow-lg p-2 overflow-x-auto">
                  <div className="flex space-x-2">
                    {sectionKeys.map(sectionKey => {
                      const Icon = getSectionIcon(sectionKey);
                      const displayName = sectionKey.replace(/^\d+\.\s*/, '').substring(0, 30);
                      
                      return (
                        <button
                          key={sectionKey}
                          onClick={() => setActiveTab(sectionKey)}
                          className={`flex items-center space-x-2 px-4 py-3 rounded-lg font-medium whitespace-nowrap transition-all ${
                            activeTab === sectionKey ? 
                            'bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-md' : 
                            'text-gray-600 hover:bg-gray-100'
                          }`}
                        >
                          <Icon className="w-4 h-4" />
                          <span>{displayName}</span>
                        </button>
                      );
                    })}
                  </div>
                </div>
              </div>
            );
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50">
              <div className="bg-white border-b border-gray-200 shadow-sm">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center space-x-4">
                      <div className="w-12 h-12 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-xl flex items-center justify-center shadow-lg">
                        <BarChart3 className="w-7 h-7 text-white" />
                      </div>
                      <div>
                        <h1 className="text-2xl font-bold text-gray-900">Strategic GTM Agent</h1>
                        <p className="text-sm text-gray-600">AI-Powered Prospect Analysis with Vertex AI & BigQuery</p>
                      </div>
                    </div>
                    <a 
                      href="/data-explorer.html" 
                      className="px-6 py-3 bg-gradient-to-r from-green-600 to-teal-600 text-white rounded-xl font-semibold hover:from-green-700 hover:to-teal-700 transition-all shadow-lg hover:shadow-xl flex items-center"
                    >
                      <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
                        <ellipse cx="12" cy="5" rx="9" ry="3"/>
                        <path d="M3 5v14c0 1.7 4 3 9 3s9-1.3 9-3V5"/>
                        <path d="M3 12c0 1.7 4 3 9 3s9-1.3 9-3"/>
                      </svg>
                      Data Explorer
                    </a>
                  </div>
                </div>
              </div>

              <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-6">
                <div className="bg-white rounded-xl shadow-lg p-2 inline-flex">
                  <button
                    onClick={() => {
                      setActiveMode('individual');
                      setSelectedBatchCompany(null);
                    }}
                    className={`px-6 py-3 rounded-lg font-medium transition-all ${
                      activeMode === 'individual' 
                        ? 'bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-md' 
                        : 'text-gray-600 hover:bg-gray-100'
                    }`}
                  >
                    Individual Analysis
                  </button>
                  <button
                    onClick={() => {
                      setActiveMode('batch');
                      setAnalysis(null);
                    }}
                    className={`px-6 py-3 rounded-lg font-medium transition-all ${
                      activeMode === 'batch' 
                        ? 'bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-md' 
                        : 'text-gray-600 hover:bg-gray-100'
                    }`}
                  >
                    Batch Analysis
                  </button>
                </div>
              </div>

              <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                {/* Individual Analysis Mode */}
                {activeMode === 'individual' && !analysis && (
                  <div className="space-y-6">
                    <div className="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl shadow-xl p-8 text-white">
                      <h2 className="text-3xl font-bold mb-3">Target Company Analysis</h2>
                      <p className="text-blue-100 text-lg">AI-powered insights with Vertex AI & BigQuery</p>
                    </div>

                    <div className="bg-white rounded-2xl shadow-xl p-8">
                      <h3 className="text-xl font-bold text-gray-900 mb-6">Analyze a Company</h3>
                      <div className="space-y-6">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">Company Name</label>
                          <input 
                            type="text" 
                            value={companyInput} 
                            onChange={(e) => setCompanyInput(e.target.value)}
                            placeholder="e.g., Tesla, Microsoft, Apple" 
                            className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">Analysis Directive</label>
                          <textarea 
                            value={directive} 
                            onChange={(e) => setDirective(e.target.value)}
                            placeholder="e.g., Evaluate as potential customer for enterprise software" 
                            rows={4} 
                            className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          />
                        </div>

                        <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
                          <h4 className="font-semibold text-blue-900 mb-3 flex items-center">
                            <Zap className="w-4 h-4 mr-2" />
                            Sample Directives:
                          </h4>
                          <div className="space-y-2">
                            {sampleDirectives.map((sample, idx) => (
                              <button 
                                key={idx}
                                onClick={() => setDirective(sample)}
                                className="w-full text-left text-sm text-blue-700 hover:text-blue-900 bg-white hover:bg-blue-100 px-3 py-2 rounded-lg transition-colors"
                              >
                                • {sample}
                              </button>
                            ))}
                          </div>
                        </div>

                        {error && (
                          <div className="bg-red-50 border-2 border-red-200 rounded-xl p-4 flex items-start">
                            <AlertCircle className="w-5 h-5 text-red-600 mr-3 mt-0.5" />
                            <div className="text-sm text-red-800">{error}</div>
                          </div>
                        )}

                        <button 
                          onClick={handleAnalyze}
                          disabled={loading || !companyInput || !directive}
                          className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-4 px-6 rounded-xl font-semibold hover:from-blue-700 hover:to-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-xl flex items-center justify-center"
                        >
                          {loading ? (
                            <>
                              <svg className="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24">
                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                              </svg>
                              Analyzing with AI...
                            </>
                          ) : (
                            <>
                              Generate Analysis
                              <ArrowRight className="w-5 h-5 ml-2" />
                            </>
                          )}
                        </button>
                      </div>
                    </div>
                  </div>
                )}

                {/* Individual Analysis Results */}
                {activeMode === 'individual' && analysis && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-2xl shadow-xl p-6">
                      <div className="flex justify-between items-start mb-6">
                        <div>
                          <h2 className="text-3xl font-bold text-gray-900 mb-2">{analysis.companyName}</h2>
                          <p className="text-sm text-blue-600 font-medium">Directive: {analysis.directive}</p>
                        </div>
                        <button 
                          onClick={handleReset}
                          className="px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 font-medium transition-colors"
                        >
                          New Analysis
                        </button>
                      </div>
                      {renderDashboardHeader(analysis)}
                    </div>

                    {renderDashboardTabs(analysis)}
                    
                    {analysis.sections && activeTab && analysis.sections[activeTab] ? (
                      <div className="bg-white rounded-xl p-6 border-2 border-gray-200" style={{ maxHeight: '600px', overflowY: 'auto', paddingRight: '10px' }}>
                        <ContentRenderer content={analysis.sections[activeTab]} sectionName={activeTab} />
                      </div>
                    ) : (
                      <div className="bg-white rounded-xl p-6 border-2 border-gray-200">
                        <div className="prose prose-slate max-w-none" style={{ maxHeight: '600px', overflowY: 'auto', paddingRight: '10px' }}>
                          <div className="whitespace-pre-wrap text-gray-700 leading-relaxed">{analysis.fullAnalysis}</div>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Batch Analysis Mode */}
                {activeMode === 'batch' && !selectedBatchCompany && (
                  <div className="space-y-6">
                    <div className="bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl shadow-xl p-8 text-white">
                      <h2 className="text-3xl font-bold mb-3">Batch Company Analysis</h2>
                      <p className="text-purple-100 text-lg">Analyze multiple companies at once with CSV or Excel upload</p>
                    </div>

                    <div className="bg-white rounded-2xl shadow-xl p-8">
                      <h3 className="text-xl font-bold text-gray-900 mb-6">Upload File</h3>
                      
                      <div className="border-4 border-dashed border-gray-300 rounded-xl p-12 text-center hover:border-blue-500 transition-colors">
                        <Upload className="w-16 h-16 mx-auto text-gray-400 mb-4" />
                        <h4 className="text-lg font-semibold text-gray-900 mb-2">Upload CSV or Excel File</h4>
                        <p className="text-sm text-gray-600 mb-4">File must contain columns: company_name, directive</p>
                        
                        <input
                          type="file"
                          accept=".csv,.xlsx,.xls"
                          onChange={handleFileSelect}
                          className="hidden"
                          id="fileInput"
                        />
                        
                        <label
                          htmlFor="fileInput"
                          className="inline-block px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 cursor-pointer transition-colors"
                        >
                          <FileText className="w-5 h-5 inline mr-2" />
                          Choose File
                        </label>
                        
                        {selectedFile && (
                          <div className="mt-4 text-sm text-green-600 font-medium">
                            ✓ Selected: {selectedFile.name}
                          </div>
                        )}
                      </div>

                      <div className="mt-6 flex space-x-4">
                        <button
                          onClick={handleBatchAnalyze}
                          disabled={!selectedFile || batchLoading}
                          className="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 px-6 rounded-xl font-semibold hover:from-purple-700 hover:to-pink-700 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-xl flex items-center justify-center"
                        >
                          {batchLoading ? (
                            <>
                              <svg className="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24">
                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                              </svg>
                              Processing... {Math.round(batchProgress)}%
                            </>
                          ) : (
                            <>
                              Analyze Batch
                              <ArrowRight className="w-5 h-5 ml-2" />
                            </>
                          )}
                        </button>
                        
                        <button
                          onClick={downloadTemplate}
                          className="px-6 py-4 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 font-semibold transition-colors flex items-center"
                        >
                          <Download className="w-5 h-5 mr-2" />
                          Download Template
                        </button>
                      </div>

                      {batchLoading && (
                        <div className="mt-6 bg-blue-50 border-2 border-blue-200 rounded-xl p-6">
                          <div className="flex items-center justify-between mb-2">
                            <span className="text-sm font-semibold text-blue-900">Processing batch...</span>
                            <span className="text-sm font-bold text-blue-900">{Math.round(batchProgress)}%</span>
                          </div>
                          <div className="w-full bg-blue-200 rounded-full h-4">
                            <div 
                              className="bg-gradient-to-r from-blue-600 to-indigo-600 h-4 rounded-full transition-all duration-500"
                              style={{width: `${batchProgress}%`}}
                            ></div>
                          </div>
                          <p className="text-xs text-blue-700 mt-2">This may take several minutes for large batches...</p>
                        </div>
                      )}

                      {error && (
                        <div className="mt-6 bg-red-50 border-2 border-red-200 rounded-xl p-4 flex items-start">
                          <AlertCircle className="w-5 h-5 text-red-600 mr-3 mt-0.5" />
                          <div className="text-sm text-red-800">{error}</div>
                        </div>
                      )}
                    </div>

                    {batchResults.length > 0 && (
                      <div className="bg-white rounded-2xl shadow-xl p-8">
                        <div className="flex justify-between items-center mb-6">
                          <h3 className="text-xl font-bold text-gray-900">Results ({batchResults.length} companies) - Ranked by Score</h3>
                          <button
                            onClick={handleExportExcel}
                            className="px-6 py-3 bg-green-600 text-white rounded-xl hover:bg-green-700 font-semibold transition-colors flex items-center"
                          >
                            <Download className="w-5 h-5 mr-2" />
                            Export to Excel
                          </button>
                        </div>

                        <div className="overflow-x-auto">
                          <table className="w-full">
                            <thead>
                              <tr className="bg-gray-50 border-b-2 border-gray-200">
                                <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Rank</th>
                                <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Company</th>
                                <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Prospect Level</th>
                                <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Score</th>
                                <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Industry</th>
                                <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Actions</th>
                              </tr>
                            </thead>
                            <tbody>
                              {batchResults.map((result, idx) => (
                                <tr key={idx} className="border-b border-gray-200 hover:bg-blue-50 transition-colors cursor-pointer" onClick={() => viewBatchCompanyDetails(result)}>
                                  <td className="px-4 py-4 text-sm font-medium text-gray-900">{idx + 1}</td>
                                  <td className="px-4 py-4 text-sm font-semibold text-gray-900">{result.company}</td>
                                  <td className="px-4 py-4">
                                    <span className={`px-3 py-1 rounded-full text-xs font-semibold ${getBadgeColor(result.prospect_level)}`}>
                                      {result.prospect_level || 'N/A'}
                                    </span>
                                  </td>
                                  <td className="px-4 py-4 text-sm font-bold text-gray-900">{result.score || 'Unknown'}</td>
                                  <td className="px-4 py-4 text-sm text-gray-600">{result.structured_data?.industry || 'Unknown'}</td>
                                  <td className="px-4 py-4">
                                    <button
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        viewBatchCompanyDetails(result);
                                      }}
                                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium transition-colors flex items-center"
                                    >
                                      <Eye className="w-4 h-4 mr-2" />
                                      View Details
                                    </button>
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Batch Company Detail View */}
                {activeMode === 'batch' && selectedBatchCompany && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-2xl shadow-xl p-6">
                      <div className="flex justify-between items-start mb-6">
                        <div>
                          <h2 className="text-3xl font-bold text-gray-900 mb-2">{selectedBatchCompany.companyName}</h2>
                          <p className="text-sm text-blue-600 font-medium">Directive: {selectedBatchCompany.directive}</p>
                          <p className="text-xs text-gray-500 mt-1">From batch analysis</p>
                        </div>
                        <button 
                          onClick={closeBatchDetails}
                          className="px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 font-medium transition-colors flex items-center"
                        >
                          <ArrowLeft className="w-4 h-4 mr-2" />
                          Back to List
                        </button>
                      </div>
                      {renderDashboardHeader(selectedBatchCompany)}
                    </div>

                    {renderDashboardTabs(selectedBatchCompany)}
                    
                    {selectedBatchCompany.sections && activeTab && selectedBatchCompany.sections[activeTab] ? (
                      <div className="bg-white rounded-xl p-6 border-2 border-gray-200" style={{ maxHeight: '600px', overflowY: 'auto', paddingRight: '10px' }}>
                        <ContentRenderer content={selectedBatchCompany.sections[activeTab]} sectionName={activeTab} />
                      </div>
                    ) : (
                      <div className="bg-white rounded-xl p-6 border-2 border-gray-200">
                        <div className="prose prose-slate max-w-none" style={{ maxHeight: '600px', overflowY: 'auto', paddingRight: '10px' }}>
                          <div className="whitespace-pre-wrap text-gray-700 leading-relaxed">{selectedBatchCompany.fullAnalysis}</div>
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </div>
            </div>
          );
        }

        ReactDOM.render(<BiAnalystAgent />, document.getElementById('root'));
    </script>
</body>
</html>
